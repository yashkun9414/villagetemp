<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gujarat Weather Alert System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .feature-card {
            transition: transform 0.3s ease;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        .stats-section {
            background: #f8f9fa;
        }
        /* Map Styles */
        #map { 
            height: 500px; 
            width: 100%; 
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .control-panel { 
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-width: 300px;
            z-index: 1000;
        }
        .leaflet-popup-content-wrapper { 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
        }
        .loader-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(255, 255, 255, 0.8); 
            z-index: 9999; 
            display: none; 
            justify-content: center; 
            align-items: center; 
        }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-radius: 50%; 
            border-top: 4px solid #667eea; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .notification { 
            position: fixed; 
            top: 100px; 
            right: 20px; 
            padding: 15px 20px; 
            border-radius: 8px; 
            color: white; 
            z-index: 10000; 
            opacity: 0; 
            transition: opacity 0.5s; 
            font-weight: 500;
        }
        .notification.show { 
            opacity: 1; 
        }
        .notification.success { 
            background-color: #28a745; 
        }
        .notification.error { 
            background-color: #dc3545; 
        }
        .notification.info { 
            background-color: #17a2b8; 
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background: rgba(102, 126, 234, 0.9); backdrop-filter: blur(10px);">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-cloud-sun me-2"></i>Gujarat Weather Alert
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#features">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#about">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#contact">Contact</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn btn-outline-light ms-2 px-3" href="/admin">Admin Panel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section text-white">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-4 fw-bold mb-4">Gujarat Weather Alert System</h1>
                    <p class="lead mb-4">Stay informed about weather conditions, temperature alerts, and fire risks across Gujarat. Get real-time alerts delivered directly to your Telegram.</p>
                    <div class="d-flex flex-wrap gap-3">
                        <a href="#map-section" class="btn btn-custom btn-lg">
                            <i class="fas fa-map me-2"></i>View Map
                        </a>
                        <a href="https://t.me/VillaegWarningbot" class="btn btn-outline-light btn-lg" target="_blank">
                            <i class="fab fa-telegram me-2"></i>Start Bot
                        </a>
                    </div>
                </div>
                <div class="col-lg-6 text-center">
                    <div class="position-relative">
                        <i class="fas fa-cloud-sun" style="font-size: 15rem; opacity: 0.1;"></i>
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <i class="fas fa-thermometer-half text-warning" style="font-size: 4rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Map Section -->
    <section id="map-section" class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center mb-5">
                    <h2 class="display-5 fw-bold">Gujarat Weather Map</h2>
                    <p class="lead text-muted">Interactive map showing weather data and fire incidents across Gujarat</p>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="position-relative">
                        <div id="loader-overlay" class="loader-overlay">
                            <div class="loader"></div>
                        </div>
                        <div id="notification" class="notification"></div>
                        
                        <div id="map"></div>
                        
                        <div class="control-panel">
                            <h5 class="mb-3"><i class="fas fa-cog me-2"></i>Map Controls</h5>
                            
                            <div class="mb-3">
                                <button id="getLocationBtn" class="btn btn-primary w-100 mb-2">
                                    <i class="fas fa-location-arrow me-2"></i>My Location
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">District</label>
                                <select id="district-select" class="form-select">
                                    <option value="">Select District</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Taluka</label>
                                <select id="taluka-select" class="form-select" disabled>
                                    <option value="">Select Taluka</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <button id="downloadBtn" class="btn btn-success w-100">
                                    <i class="fas fa-download me-2"></i>Download Data
                                </button>
                            </div>
                            
                            <div id="info-panel" class="mt-3" style="display: none;">
                                <h6 id="info-title"></h6>
                                <div id="weather-info"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats-section py-5">
        <div class="container">
            <div class="row text-center">
                <div class="col-md-3 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body">
                            <i class="fas fa-map text-primary mb-3" style="font-size: 3rem;"></i>
                            <h3 class="fw-bold">33</h3>
                            <p class="text-muted">Districts Covered</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body">
                            <i class="fas fa-map-marker-alt text-success mb-3" style="font-size: 3rem;"></i>
                            <h3 class="fw-bold">235</h3>
                            <p class="text-muted">Talukas Monitored</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body">
                            <i class="fas fa-bell text-warning mb-3" style="font-size: 3rem;"></i>
                            <h3 class="fw-bold">24/7</h3>
                            <p class="text-muted">Alert Monitoring</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body">
                            <i class="fab fa-telegram text-info mb-3" style="font-size: 3rem;"></i>
                            <h3 class="fw-bold">Active</h3>
                            <p class="text-muted">Telegram Bot</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center mb-5">
                    <h2 class="display-5 fw-bold">System Features</h2>
                    <p class="lead text-muted">Comprehensive weather monitoring and alert system for Gujarat</p>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-thermometer-full text-danger mb-3" style="font-size: 3rem;"></i>
                            <h4 class="fw-bold">Temperature Alerts</h4>
                            <p class="text-muted">Get notified when temperatures exceed safe limits. Real-time monitoring of heat waves and extreme weather conditions.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-fire text-warning mb-3" style="font-size: 3rem;"></i>
                            <h4 class="fw-bold">Fire Risk Monitoring</h4>
                            <p class="text-muted">Historical fire data analysis and risk assessment. Stay informed about fire-prone areas and safety measures.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fab fa-telegram text-info mb-3" style="font-size: 3rem;"></i>
                            <h4 class="fw-bold">Telegram Integration</h4>
                            <p class="text-muted">Subscribe to location-specific alerts via Telegram bot. Choose your district and taluka for targeted notifications.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-map text-primary mb-3" style="font-size: 3rem;"></i>
                            <h4 class="fw-bold">Interactive Map</h4>
                            <p class="text-muted">Visual representation of weather data and fire incidents across Gujarat with detailed location information.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-shield-alt text-success mb-3" style="font-size: 3rem;"></i>
                            <h4 class="fw-bold">Admin Panel</h4>
                            <p class="text-muted">Secure administrative interface for sending custom alerts, monitoring system status, and managing users.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card feature-card h-100">
                        <div class="card-body text-center p-4">
                            <i class="fas fa-clock text-secondary mb-3" style="font-size: 3rem;"></i>
                            <h4 class="fw-bold">Real-time Updates</h4>
                            <p class="text-muted">Continuous monitoring and instant alert delivery. Stay updated with the latest weather conditions and safety information.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- How to Use Section -->
    <section class="py-5 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center mb-5">
                    <h2 class="display-5 fw-bold">How to Get Started</h2>
                    <p class="lead text-muted">Simple steps to start receiving weather alerts</p>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-3 mb-4">
                    <div class="text-center">
                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                            <span class="fs-3 fw-bold">1</span>
                        </div>
                        <h4>Find the Bot</h4>
                        <p class="text-muted">Search for our Telegram bot and start a conversation</p>
                    </div>
                </div>
                <div class="col-lg-3 mb-4">
                    <div class="text-center">
                        <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                            <span class="fs-3 fw-bold">2</span>
                        </div>
                        <h4>Subscribe</h4>
                        <p class="text-muted">Use /subscribe command to choose your district and taluka</p>
                    </div>
                </div>
                <div class="col-lg-3 mb-4">
                    <div class="text-center">
                        <div class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                            <span class="fs-3 fw-bold">3</span>
                        </div>
                        <h4>Receive Alerts</h4>
                        <p class="text-muted">Get instant notifications about weather conditions in your area</p>
                    </div>
                </div>
                <div class="col-lg-3 mb-4">
                    <div class="text-center">
                        <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                            <span class="fs-3 fw-bold">4</span>
                        </div>
                        <h4>Stay Safe</h4>
                        <p class="text-muted">Follow safety recommendations and stay informed</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about" class="py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h2 class="display-5 fw-bold mb-4">About the System</h2>
                    <p class="lead mb-4">The Gujarat Weather Alert System is designed to help communities stay safe and informed about weather conditions across the state.</p>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Real-time weather monitoring</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Historical fire data analysis</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Location-specific alerts</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Easy-to-use Telegram interface</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Administrative control panel</li>
                    </ul>
                </div>
                <div class="col-lg-6">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-users text-primary mb-2" style="font-size: 2rem;"></i>
                                    <h5>Community Focused</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-mobile-alt text-success mb-2" style="font-size: 2rem;"></i>
                                    <h5>Mobile Friendly</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-lock text-warning mb-2" style="font-size: 2rem;"></i>
                                    <h5>Secure</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-bolt text-danger mb-2" style="font-size: 2rem;"></i>
                                    <h5>Fast Alerts</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" class="py-5 bg-dark text-white">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="display-5 fw-bold mb-4">Get Started Today</h2>
                    <p class="lead mb-4">Join thousands of users who trust our weather alert system</p>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <a href="https://t.me/VillaegWarningbot" class="btn btn-custom btn-lg" target="_blank">
                            <i class="fab fa-telegram me-2"></i>Start Using Bot
                        </a>
                        <a href="/admin" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-cog me-2"></i>Admin Access
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-4 bg-secondary text-white text-center">
        <div class="container">
            <p class="mb-0">&copy; 2024 Gujarat Weather Alert System. Built for community safety.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // Add navbar background on scroll
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 50) {
                navbar.style.background = 'rgba(102, 126, 234, 0.95)';
            } else {
                navbar.style.background = 'rgba(102, 126, 234, 0.9)';
            }
        });

        // Map functionality
        let map;
        let locationData = [];
        let displayedDataForCSV = [];
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([22.30, 71.18], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }
        
        // Load CSV data and weather data
        async function loadCSVData() {
            try {
                const response = await fetch('/static/merged_village_temperature_data.csv');
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        locationData = results.data;
                        populateDropdowns();
                        loadWeatherData();
                        showNotification('Data loaded successfully!', 'success');
                    }
                });
            } catch (error) {
                console.error('Error loading CSV:', error);
                showNotification('Error loading location data', 'error');
            }
        }
        
        // Load real weather data for map
        async function loadWeatherData() {
            try {
                const response = await fetch('/api/weather_map_data');
                const data = await response.json();
                
                if (data.success) {
                    displayWeatherOnMap(data.locations);
                } else {
                    console.error('Failed to load weather data:', data.error);
                }
            } catch (error) {
                console.error('Error loading weather data:', error);
            }
        }
        
        // Display weather data on map
        function displayWeatherOnMap(weatherLocations) {
            weatherLocations.forEach(location => {
                if (location.latitude && location.longitude) {
                    const temp = location.current_temp;
                    const isHot = temp >= 40;
                    const isCold = temp <= 5;
                    
                    // Choose marker color based on temperature
                    let markerColor = 'blue';
                    if (isHot) markerColor = 'red';
                    else if (isCold) markerColor = 'lightblue';
                    else if (temp >= 35) markerColor = 'orange';
                    else if (temp >= 25) markerColor = 'green';
                    
                    // Create custom marker
                    const marker = L.circleMarker([location.latitude, location.longitude], {
                        radius: 8,
                        fillColor: markerColor,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    // Create popup with weather info
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h6><strong>${location.location}</strong></h6>
                            <p><strong>üå°Ô∏è Temperature:</strong> ${temp}¬∞C</p>
                            <p><strong>üìä Max/Min:</strong> ${location.max_temp}¬∞C / ${location.min_temp}¬∞C</p>
                            <p><strong>üíß Humidity:</strong> ${location.humidity}%</p>
                            <p><strong>üí® Wind:</strong> ${location.wind_speed} km/h</p>
                            <p><strong>‚òÅÔ∏è Condition:</strong> ${location.weather_description}</p>
                            ${isHot ? '<p style="color: red;"><strong>‚ö†Ô∏è HIGH TEMPERATURE ALERT</strong></p>' : ''}
                            ${isCold ? '<p style="color: blue;"><strong>‚ö†Ô∏è LOW TEMPERATURE ALERT</strong></p>' : ''}
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                }
            });
        }
        
        // Populate dropdowns
        function populateDropdowns() {
            const districtSelect = document.getElementById('district-select');
            const districts = [...new Set(locationData.map(item => item['District Name']))].filter(Boolean).sort();
            
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
        
        // Handle district selection
        document.getElementById('district-select').addEventListener('change', function() {
            const selectedDistrict = this.value;
            const talukaSelect = document.getElementById('taluka-select');
            
            // Clear taluka options
            talukaSelect.innerHTML = '<option value="">Select Taluka</option>';
            
            if (selectedDistrict) {
                talukaSelect.disabled = false;
                
                const talukas = [...new Set(locationData
                    .filter(item => item['District Name'] === selectedDistrict)
                    .map(item => item['Taluka Name'])
                )].filter(Boolean).sort();
                
                talukas.forEach(taluka => {
                    const option = document.createElement('option');
                    option.value = taluka;
                    option.textContent = taluka;
                    talukaSelect.appendChild(option);
                });
            } else {
                talukaSelect.disabled = true;
            }
        });
        
        // Handle taluka selection
        document.getElementById('taluka-select').addEventListener('change', function() {
            const selectedDistrict = document.getElementById('district-select').value;
            const selectedTaluka = this.value;
            
            if (selectedDistrict && selectedTaluka) {
                const talukaData = locationData.find(item => 
                    item['District Name'] === selectedDistrict && 
                    item['Taluka Name'] === selectedTaluka
                );
                
                if (talukaData && talukaData['Taluka Latitude'] && talukaData['Taluka Longitude']) {
                    const lat = parseFloat(talukaData['Taluka Latitude']);
                    const lng = parseFloat(talukaData['Taluka Longitude']);
                    
                    map.setView([lat, lng], 12);
                    
                    // Load weather data for this taluka
                    loadTalukaWeather(selectedDistrict, selectedTaluka, lat, lng);
                }
            }
        });
        
        // Load weather data for specific taluka
        async function loadTalukaWeather(district, taluka, lat, lng) {
            try {
                showLoader(true);
                const response = await fetch(`/weather/${district}/${taluka}`);
                const data = await response.json();
                
                if (data.success) {
                    const weather = data.weather;
                    const temp = weather.current_temp;
                    const isHot = temp >= 40;
                    const isCold = temp <= 5;
                    
                    // Choose marker color based on temperature
                    let markerColor = 'blue';
                    if (isHot) markerColor = 'red';
                    else if (isCold) markerColor = 'lightblue';
                    else if (temp >= 35) markerColor = 'orange';
                    else if (temp >= 25) markerColor = 'green';
                    
                    // Create weather marker
                    const marker = L.circleMarker([lat, lng], {
                        radius: 12,
                        fillColor: markerColor,
                        color: '#000',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    // Create detailed popup
                    const popupContent = `
                        <div style="min-width: 250px;">
                            <h5><strong>${taluka}, ${district}</strong></h5>
                            <hr>
                            <p><strong>üå°Ô∏è Current Temperature:</strong> ${temp}¬∞C</p>
                            <p><strong>üìä Max/Min Today:</strong> ${weather.max_temp}¬∞C / ${weather.min_temp}¬∞C</p>
                            <p><strong>üíß Humidity:</strong> ${weather.humidity}%</p>
                            <p><strong>üí® Wind Speed:</strong> ${weather.wind_speed} km/h</p>
                            <p><strong>‚òÅÔ∏è Condition:</strong> ${weather.weather_description}</p>
                            <p><strong>üïê Updated:</strong> ${new Date(weather.timestamp).toLocaleString()}</p>
                            ${isHot ? '<div style="color: red; font-weight: bold;">‚ö†Ô∏è HIGH TEMPERATURE ALERT</div>' : ''}
                            ${isCold ? '<div style="color: blue; font-weight: bold;">‚ö†Ô∏è LOW TEMPERATURE ALERT</div>' : ''}
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent).openPopup();
                    
                    // Update info panel
                    showLocationInfo(taluka, district, weather);
                    
                } else {
                    // Fallback marker without weather data
                    L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup(`<b>${taluka}</b><br>${district}<br><em>Weather data not available</em>`)
                        .openPopup();
                }
                
                showLoader(false);
            } catch (error) {
                console.error('Error loading taluka weather:', error);
                showLoader(false);
                
                // Fallback marker
                L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup(`<b>${taluka}</b><br>${district}`)
                    .openPopup();
            }
        }
        
        // Get user location
        document.getElementById('getLocationBtn').addEventListener('click', function() {
            if (navigator.geolocation) {
                showLoader(true);
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        map.setView([lat, lng], 13);
                        
                        L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup('Your Location')
                            .openPopup();
                        
                        showNotification('Location found!', 'success');
                        showLoader(false);
                    },
                    function(error) {
                        showNotification('Could not get your location', 'error');
                        showLoader(false);
                    }
                );
            } else {
                showNotification('Geolocation is not supported', 'error');
            }
        });
        
        // Show location info with weather data
        function showLocationInfo(taluka, district, weather = null) {
            const infoPanel = document.getElementById('info-panel');
            const infoTitle = document.getElementById('info-title');
            const weatherInfo = document.getElementById('weather-info');
            
            infoTitle.textContent = `${taluka}, ${district}`;
            
            if (weather) {
                const temp = weather.current_temp;
                const isHot = temp >= 40;
                const isCold = temp <= 5;
                
                weatherInfo.innerHTML = `
                    <div class="weather-details">
                        <div class="mb-2">
                            <strong>üå°Ô∏è Temperature:</strong> 
                            <span class="${isHot ? 'text-danger' : isCold ? 'text-primary' : ''}">${temp}¬∞C</span>
                        </div>
                        <div class="mb-2">
                            <strong>üìä Range:</strong> ${weather.max_temp}¬∞C / ${weather.min_temp}¬∞C
                        </div>
                        <div class="mb-2">
                            <strong>üíß Humidity:</strong> ${weather.humidity}%
                        </div>
                        <div class="mb-2">
                            <strong>‚òÅÔ∏è Condition:</strong> ${weather.weather_description}
                        </div>
                        ${isHot ? '<div class="alert alert-danger p-2 mt-2"><small>‚ö†Ô∏è High Temperature Alert</small></div>' : ''}
                        ${isCold ? '<div class="alert alert-primary p-2 mt-2"><small>‚ö†Ô∏è Low Temperature Alert</small></div>' : ''}
                    </div>
                `;
            } else {
                weatherInfo.innerHTML = '<p class="text-muted">Select a location to view weather data</p>';
            }
            
            infoPanel.style.display = 'block';
        }
        
        // Download data
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (displayedDataForCSV.length === 0) {
                showNotification('No data to download', 'info');
                return;
            }
            
            const csv = Papa.unparse(displayedDataForCSV);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'gujarat_weather_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Data downloaded successfully!', 'success');
        });
        
        // Show location info
        function showLocationInfo(taluka, district) {
            const infoPanel = document.getElementById('info-panel');
            const infoTitle = document.getElementById('info-title');
            const weatherInfo = document.getElementById('weather-info');
            
            infoTitle.textContent = `${taluka}, ${district}`;
            weatherInfo.innerHTML = `
                <p><small class="text-muted">Location selected on map</small></p>
                <p><i class="fas fa-map-marker-alt me-2"></i>District: ${district}</p>
                <p><i class="fas fa-location-dot me-2"></i>Taluka: ${taluka}</p>
            `;
            
            infoPanel.style.display = 'block';
            
            // Add to download data
            displayedDataForCSV.push({
                district: district,
                taluka: taluka,
                timestamp: new Date().toISOString()
            });
        }
        
        // Utility functions
        function showLoader(show) {
            document.getElementById('loader-overlay').style.display = show ? 'flex' : 'none';
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.className = 'notification';
            }, 3000);
        }
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadCSVData();
        });
    </script>
</body>
</html>